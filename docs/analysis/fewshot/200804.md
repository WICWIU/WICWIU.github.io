이곳은 **fewshot-learning** 을 구현하기 위한 [**WICWIU**](https://github.com/WICWIU/WICWIU) 개발팀의 [**WICWIU**](https://github.com/WICWIU/WICWIU) 분석 과정을 기록해두는 곳입니다.

# CasiaWebFace Image to vector

## Coding: `getDirList` 함수

먼저 **CasiaWebFace** 이미지를 자동으로 읽어오기 위하여 디렉토리 리스트를 얻을 수 있는 코드를 짰습니다.

```c++ linenums="1"
#include <string>
#include <iostream>
#include <fstream>
#include <iterator>
#include <vector>
#include <dirent.h>
#include <sys/types.h>

DIR* getDirList(const char * dirName)
{
    DIR *dir;
    if ((dir = opendir(dirName)) == NULL)
        throw std::invalid_argument("could not open directory");
    return dir;
}
```

- **11행~14행**:

    `getDirList` 함수에 디렉토리 경로를 입력하면 디렉토리 내부 파일 정보를 갖고 있는 `DIR` 포인터를 반환합니다. 

    이 함수를 사용하여 다음과 같이 **CasiaWebFace** 이미지가 저장되어 있는 `/tmp/casia_train` 디렉토리의 내부 파일을 반환받는 코드를 짤 수 있습니다.

## Coding: `test_getDirList` 함수

!!! info

    `test_getDirList` 함수의 `test_` 는 **camel case** 가 아닌 **snake case** 로 되어있는데, 테스트 코드임을 강조하기 위하여 그렇게 한 것입니다. 나머지 코드는 모두 **camel case** 로 코딩되어 있습니다.

```c++ linenums="1"
void test_getDirList(bool error=false);

int main(int argc, char const *argv[])
{
    test_getDirList();
    return EXIT_SUCCESS;
}

void test_getDirList(bool error)
{
    DIR* dir;
    try
    {
        dir = (error) ?\
            getDirList("aweoifjaowief") :\
            dir = getDirList("/tmp/casia_train");
        struct dirent *ent;

        while ((ent = readdir(dir)) != NULL)
        {
            std::cout << ent->d_name << std::endl;
        }
        closedir(dir);
    } 
    catch (const std::invalid_argument& e)
    {
        std::cerr << e.what() << std::endl;
    }
}
```

- **1행**:

    `test_getDirList` 는 `error` 인자를 받는데 `false` 가 기본값으로 설정되어 있습니다. 

- **14행~21행**:

    `error = false` 인  경우 `/tmp/casia_train` 디렉토리 내부 파일들을 출력합니다. 

- **14행~21행**:

    `error` 를 `true` 로 설정한다면 의도적으로 에러를 발생시키는 코드가 됩니다. 즉, 존재하지 않는 파일 경로를 `getDirList` 함수에 입력하여 에러를 발생시켜서 에러 처리 코드(`try~catch`) 가 잘 작동하는지 검증하는 것입니다.

## Coding: `test_getFirstCasiaImage` 함수

```c++ linenums="1"
void test_getFirstCasiaTrainImage();

int main(int argc, char const *argv[])
{
    test_getFirstCasiaTrainImage();
    return EXIT_SUCCESS;
}

void test_getFirstCasiaTrainImage()
{
    DIR * dir;
    std::string casiaTrainDirPath = "/tmp/casia_train";
    std::string casiaTrainFirstDirPath;
    std::string casiaTrainFirstImagePath;

    //
    // Get first directory of casia_train
    //
    try
    {
        dir = getDirList(casiaTrainDirPath.c_str());
        if (dir == nullptr)
            throw;
        struct dirent *ent;

        for (int idx = 0; (ent = readdir(dir)) != NULL; idx++)
        {
            if (idx == 2) // first index (because: 0 -> . 1 -> .. 2 -> first path)
            {
                casiaTrainFirstDirPath = casiaTrainDirPath + "/" + std::string(ent->d_name);
            }
        }
        closedir(dir);
    } 
    catch (const std::invalid_argument& e)
    {
        std::cerr << e.what() << std::endl;
    }

    //
    // Get first image of first directory
    //
    try
    {
        dir = getDirList(casiaTrainFirstDirPath.c_str());
        if (dir == nullptr)
            throw;
        struct dirent *ent;

        for (int idx = 0; (ent = readdir(dir)) != NULL; idx++)
        {
            if (idx == 2) // first index (because: 0 -> . 1 -> .. 2 -> first path)
            {
                casiaTrainFirstImagePath = casiaTrainFirstDirPath + "/" +std::string(ent->d_name);
            }
        }
        closedir(dir);
    } 
    catch (const std::invalid_argument& e)
    {
        std::cerr << e.what() << std::endl;
    }

    //
    // Convert image to vector<unsigned char>
    //
    std::ifstream casiaTrainFirstImage(casiaTrainFirstImagePath, std::ios::binary);
    std::vector<unsigned char> casiaTrainFirstImageBuffer(std::istreambuf_iterator<char>(casiaTrainFirstImage), {});
    
    //
    // Show result and converted image
    //
    std::cout << "First image of first caisa_train sub directory:" << std::endl;
    std::cout << '\t' << casiaTrainFirstImagePath  << std::endl;
    std::cout << "casiaTrainFirstImageBuffer size: " << std::endl;
    std::cout << '\t' << casiaTrainFirstImageBuffer.size() << std::endl;
    std::cout << "First 10 bytes:" << std::endl;
    std::cout << "\t";
    int ct=0;
    for (const auto byte: casiaTrainFirstImageBuffer)
    {
        if (ct < 10)
            std::cout << static_cast<int>(byte) << ' ';
        ct++;
    }
    std::cout << std::endl;
}
```

이후 `getDirList` 함수를 활용하여 `/tmp/casia_train` 의 첫번째 디렉토리의 첫번째 이미지를 읽어보는 테스트 코드를 작성했습니다. 

- **19행~39행**:

    `/tmp/casia_train` 의 첫번째 디렉토리 경로를 `casiaTrainFirstDirPath` 에 저장합니다.

- **42행~61행**:

    `/tmp/casia_train` 의 첫번째 디렉토리의 첫번째 이미지 경로를 `casiaTrainFirstImagePath` 에 저장합니다.

- **66행~67행**:

    `/tmp/casia_train` 의 첫번째 디렉토리의 첫번째 이미지를 바이너리로 읽고 `unsigned char` 자료형을 갖는 `vector` 로 변환합니다.

- **82행~87행**:

    이미지의 첫 `10` 바이트를 읽고 `int` 로 형변환하여 출력해봅니다. 그냥 잘 읽혔는지 확인하는 테스트 코드입니다.

!!! info

    [**WICWIU**](https://github.com/WICWIU/WICWIU) 는 `C++` 프로젝트이기 때문에 `C` 스타일로 코딩하는 것이 아니라 `C++` 스타일로 코딩하려고 노력하고 있습니다. 

    예를 들어서 다음 코드는 `C` 스타일 형변환입니다.

    ```c
    for (const auto byte: casiaTrainFirstImageBuffer)
    {
        std::cout << (int)(byte) << ' ';
    }
    ```

    다음 코드는 `C++` 스타일 형변환입니다.

    ```c
    for (const auto byte: casiaTrainFirstImageBuffer)
    {
        std::cout << static_cast<int>(byte) << ' ';
    }
    ```

    `C++` 프로젝트에서 `C` 스타일로 코딩하면 구닥다리 코드를 짠다고 욕먹을 수도 있고 심할 경우 프로젝트 안정성에 문제가 생길 수도 있기 때문에 주의하려구요. 다음 링크를 참조하면 `C++` 코딩 스타일 등에 대한 좋은 정보를 얻을 수 있습니다.

    - https://github.com/AnthonyCalandra/modern-cpp-features

    - https://github.com/isocpp/CppCoreGuidelines

    - https://github.com/lefticus/cppbestpractices
